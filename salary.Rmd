---
title: "Salary Prediction"
author: "R.M. Palmer"
date: "11/18/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(caret)
library(leaps)
library(MASS)
library(relaimpo)
library(car)
library(glmnet)
library(ggplot2)
```

```{r child = 'dataload.Rmd'}
```

```{r lm_common}
numeric_predictors <- c("Age",
"t_DistanceFromHome",
"t_Education",
"t_EnvironmentSatisfaction",
"t_JobInvolvement",
"t_JobLevel",
"t_JobSatisfaction",
"t_NumCompaniesWorked",
"t_PercentSalaryHike",
"t_PerformanceRating",
"t_RelationshipSatisfaction",
"t_StockOptionLevel",
"t_TotalWorkingYears",
"t_TrainingTimesLastYear",
"t_WorkLifeBalance",
"t_YearsAtCompany",
"t_YearsInCurrentRole",
"t_YearsSinceLastPromotion",
"t_YearsWithCurrManager")

factor_predictors <- c("BusinessTravel",
"Department",
"EducationField",
"Gender",
"JobRole",
"MaritalStatus")

all_predictors <- c(factor_predictors,numeric_predictors)

mi_f_all <- as.formula(paste("t_MonthlyIncome ~ ",paste(all_predictors,collapse="+")))
mi_f_num <- as.formula(paste("t_MonthlyIncome ~ ",paste(numeric_predictors,collapse="+")))
mi_f_fac <- as.formula(paste("t_MonthlyIncome ~ ",paste(factor_predictors,collapse="+")))

selected_by_relaimpo <- c("")

selected_by_stepwise <- c("BusinessTravel",
"Gender",
"JobRole",
"t_DistanceFromHome",
"t_JobLevel",
"t_PercentSalaryHike",
"t_PerformanceRating",
"t_TotalWorkingYears",
"t_YearsSinceLastPromotion",
"t_YearsWithCurrManager")

subjective_predictors <- c("Gender",
"JobRole",
"EducationField",
"t_JobLevel",
"t_TotalWorkingYears",
"t_Education",
"t_PerformanceRating",
"t_RelationshipSatisfaction",
"t_StockOptionLevel",
"t_YearsAtCompany")
                           

mi_f_stepwise <- as.formula(paste("t_MonthlyIncome ~ ",paste(selected_by_stepwise,collapse="+")))
mi_f_creosote <- as.formula(paste("t_MonthlyIncome ~ ",paste(all_predictors,collapse="+")))
mi_f_subjective <- as.formula(paste("t_MonthlyIncome ~ ",paste(subjective_predictors,collapse="+")))

train_control <- trainControl(method="LOOCV")
```

```{r useful_functions}
make_qc <- function(model) 
{
  df <- employee_data
  df$predicted <- exp(model$fitted.values)
  df$residuals <- model$residuals
  return(df)
}

qc_plots <- function(qc,label)
{
  ggplot(qc, aes(x=residuals)) + geom_histogram() + ggtitle(paste("Histograme of ",label,"residuals"))
  ggplot(qc, aes(x=MonthlyIncome,y=predicted)) + geom_point() + ggtitle(paste("predicted versus actual for ",label))
  ggplot(qc, aes(sample=residuals)) + stat_qq() + ggtitle(paste("QQ of residuals for",label))
}
```

```{r creosote}
creosote_loocv <- train(mi_f_creosote,
                      data=employee_data,
                      method="lm",trControl = train_control)
print(creosote_loocv)
creosote_r2 <- creosote_loocv$results$Rsquared
creosote_model <- creosote_loocv$finalModel
summary(creosote_model)
creosote_qc <- make_qc(creosote_model)
```

```{r}
ggplot(creosote_qc, aes(x=residuals)) + 
  geom_histogram() + 
  ggtitle(paste("Histogram of residuals from All predictors"))
```
```{r}
ggplot(creosote_qc, aes(x=MonthlyIncome,y=predicted,col=JobRole)) +
  geom_point() + 
  ggtitle(paste("predicted versus actual for All predictors"))
```
```{r}
ggplot(creosote_qc, aes(sample=residuals)) +
  stat_qq() + 
  ggtitle(paste("QQ of residuals for All predictors"))
```

```{r}
rm(creosote_loocv)
#rm(creosote_model)
rm(creosote_qc)
gc()
```

```{r subjective}
# subjectively chosen predictors
subjective_loocv <- train(mi_f_subjective,
                      data=employee_data,
                      method="lm",trControl = train_control)
print(subjective_loocv)
subjective_r2 <- subjective_loocv$results$Rsquared
subjective_model <- subjective_loocv$finalModel
summary(subjective_model)
subjective_qc <- make_qc(subjective_model)
```

```{r}
ggplot(subjective_qc, aes(x=residuals)) + 
  geom_histogram() + 
  ggtitle(paste("Histogram of residuals from Subjective Model"))
```

```{r}
ggplot(subjective_qc, aes(x=MonthlyIncome,y=predicted,color=EducationField)) +
  geom_point() + 
  ggtitle(paste("predicted versus actual for Subjective Model"))
```

```{r}
ggplot(subjective_qc, aes(sample=residuals)) +
  stat_qq() + 
  ggtitle(paste("QQ of residuals for Subjective Model"))
```

```{r}
rm(subjective_loocv)
#rm(subjective_model)
rm(subjective_qc)
gc()
```

```{r stepwise}
# stepwise
stepwise_loocv <- train(mi_f_stepwise,
                      data=employee_data,
                      method="lm",trControl = train_control)
print(stepwise_loocv)
stepwise_r2 <- stepwise_loocv$results$Rsquared
stepwise_model <- stepwise_loocv$finalModel
summary(stepwise_model)
stepwise_qc <- make_qc(stepwise_model)
```
```{r}
ggplot(stepwise_qc, aes(x=residuals)) + 
  geom_histogram() + 
  ggtitle(paste("Histogram of residuals from Stepwise"))
```
```{r}
ggplot(stepwise_qc, aes(x=MonthlyIncome,y=predicted,col=Department)) +
  geom_point() + 
  ggtitle(paste("predicted versus actual for Stepwise"))
```
```{r}
ggplot(stepwise_qc, aes(sample=residuals)) +
  stat_qq() + 
  ggtitle(paste("QQ of residuals for Stepwise"))
```

```{r predict_known}
reprise_raw <- read.csv('CaseStudy2-data.csv')
reprise_test <- my_transform(reprise_raw)
repredict <- predict(subjective_model, newdata = reprise_test)

```


```{r predict_salary}
# read in the blind test dataset

blind_raw <- read.csv('CaseStudy2CompSetNoSalary.csv')
blind_test <- my_transform(blind_raw)
predicted_salary <- predict(stepwise_model,newdata=blind_test)

for_submission <- cbind(blind_test$ID,predicted_salary)
colnames(for_submission) <- c("ID","Salary")
write.csv(for_submission,file="Case2PredictionsPalmerSalary.csv",row.names=FALSE)

```

```{r}
rm(stepwise_loocv)
#rm(stepwise_model)
rm(stepwise_qc)
gc()
```
