---
title: "Model Selection"
author: "R.M. Palmer"
date: "11/18/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(caret)
library(leaps)
library(MASS)
library(relaimpo)
library(car)
library(glmnet)
```

```{r child = 'dataload.Rmd'}
```

```{r regression_common}
numeric_predictors <- c("Age",
"DistanceFromHome",
"Education",
"EnvironmentSatisfaction",
"JobInvolvement",
"JobLevel",
"JobSatisfaction",
"NumCompaniesWorked",
"PercentSalaryHike",
"PerformanceRating",
"RelationshipSatisfaction",
"StockOptionLevel",
"TotalWorkingYears",
"TrainingTimesLastYear",
"WorkLifeBalance",
"YearsAtCompany",
"YearsInCurrentRole",
"YearsSinceLastPromotion",
"YearsWithCurrManager")

factor_predictors <- c("BusinessTravel",
"Department",
"EducationField",
"Gender",
"JobRole",
"MaritalStatus")

all_predictors <- c(factor_predictors,numeric_predictors)

mi_f_all <- as.formula(paste("MonthlyIncome ~ ",paste(all_predictors,collapse="+")))
mi_f_num <- as.formula(paste("MonthlyIncome ~ ",paste(numeric_predictors,collapse="+")))
mi_f_fac <- as.formula(paste("MonthlyIncome ~ ",paste(factor_predictors,collapse="+")))

# numeric attribution as a function of various sets of predictors
att_f_all <- as.formula(paste("numeric_attrition ~ ",paste(all_predictors,collapse="+")))
att_f_num <- as.formula(paste("numeric_attrition ~ ",paste(numeric_predictors,collapse="+")))
att_f_fac <- as.formula(paste("numeric_attrition ~ ",paste(factor_predictors,collapse="+")))
```

```{r stepwise_selection_mi}
mi_fit <- lm(mi_f_all, data=employee_data)
stepwise_mi <- stepAIC(mi_fit,direction="both")
stepwise_mi$anova
stepwise_mi$call
```

```{r stepwise_selection_att}
att_fit <- lm(att_f_all, data=employee_data)
stepwise_att <- stepAIC(att_fit,direction="both")
stepwise_att$anova
```

```{r pick_numeric}
num_fit <- lm(numeric_predictors,data=employee_data)
stepwise_numeric <- stepAIC(num_fit, direction = "both")

calc.relimp(stepwise_numeric,type=c("lmg","last","first","pratt"),
   rela=TRUE)

# Bootstrap Measures of Relative Importance (1000 samples) 
boot <- boot.relimp(stepwise_numeric, b = 1000, type = c("lmg", 
  "last", "first", "pratt"), rank = TRUE, 
  diff = TRUE, rela = TRUE)
booteval.relimp(boot) # print result
plot(booteval.relimp(boot,sort=TRUE)) # plot result
```

```{r allsubsets}
#leaps <- regsubsets(numeric_predictors,data=employee_data,nbest=5)
#summary(leaps)
#plot(leaps,scale="r2")
#subsets(leaps,statistic="rsq")
```

```{r loocv}
train_control <- trainControl(method="LOOCV")
salary_loocv <- train(MonthlyIncome ~ YearsWithCurrManager
                        +YearsSinceLastPromotion
                        +TotalWorkingYears
                        +JobRole
                        +JobLevel
                        +JobInvolvement
                        +Gender
                        +Education
                        +EducationField
                        +BusinessTravel,
                      data=employee_data,
                      method="lm",trControl = train_control)
print(salary_loocv)
```